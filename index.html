<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Revision Card Studio v4</title>
<link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Courier+Prime:wght@400;700&family=Lora:ital,wght@0,400;0,700&family=Montserrat:wght@400;700;900&family=Oswald:wght@400;700&family=Poppins:wght@400;700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',sans-serif;display:flex;height:100vh;background:#1e2836;color:#e0e6ed;overflow:hidden;}

/* â”€â”€ LAYOUT â”€â”€ */
#left-pane{width:300px;min-width:260px;display:flex;flex-direction:column;background:#253347;border-right:1px solid #1abc9c33;overflow:hidden;}
#right-pane{flex:1;display:flex;flex-direction:column;background:#1a1a2e;position:relative;overflow:hidden;}

/* â”€â”€ LEFT: TOP BAR â”€â”€ */
#left-top{padding:12px 14px;border-bottom:1px solid #1abc9c33;background:#1e2e42;}
#left-top h1{font-size:13px;font-weight:700;color:#1abc9c;letter-spacing:0.5px;margin-bottom:8px;}
.top-btns{display:flex;gap:6px;flex-wrap:wrap;}
.tb{padding:5px 10px;font-size:11px;font-weight:700;border:none;border-radius:5px;cursor:pointer;color:#fff;}
.tb-load{background:#9b59b6;}
.tb-undo{background:#2c3e50;border:1px solid #1abc9c;color:#1abc9c;}
.tb-undo:hover{background:#1abc9c;color:#2c3e50;}
.tb-undo:disabled{opacity:.3;cursor:not-allowed;}

/* â”€â”€ LEFT: CARDS LIST â”€â”€ */
#cards-list{padding:10px;overflow-y:auto;max-height:220px;border-bottom:1px solid #1abc9c22;}
.card-pill{display:flex;align-items:center;gap:6px;padding:7px 10px;border-radius:6px;cursor:pointer;font-size:12px;border-left:3px solid transparent;transition:all .15s;margin-bottom:3px;}
.card-pill:hover{background:#1e3a52;}
.card-pill.active{border-left-color:#1abc9c;background:#1a3348;color:#1abc9c;}
.card-pill-num{font-size:10px;background:#2c3e50;padding:1px 5px;border-radius:3px;color:#7f8c8d;}
.card-pill-title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.card-pill-btns{display:flex;gap:3px;opacity:0;transition:opacity .15s;}
.card-pill:hover .card-pill-btns{opacity:1;}
.cpb{padding:2px 6px;font-size:10px;border:none;border-radius:3px;cursor:pointer;font-weight:bold;color:#fff;}
.cpb-dup{background:#8e44ad;}
.cpb-del{background:#e74c3c;}
#add-card-btn{width:100%;padding:8px;background:#2980b9;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:12px;font-weight:bold;margin-top:6px;}

/* â”€â”€ LEFT: PROPERTIES PANEL â”€â”€ */
#props-panel{flex:1;overflow-y:auto;padding:12px;}
#props-panel h3{font-size:11px;color:#1abc9c;text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid #1abc9c33;}
.prop-row{margin-bottom:10px;}
.prop-row label{display:block;font-size:10px;color:#95a5a6;text-transform:uppercase;letter-spacing:.4px;margin-bottom:3px;}
.prop-row input[type=text],.prop-row select,.prop-row textarea{width:100%;padding:6px 8px;background:#1e2836;border:1px solid #34495e;border-radius:4px;color:#e0e6ed;font-size:12px;outline:none;}
.prop-row input[type=text]:focus,.prop-row select:focus{border-color:#1abc9c;}
.prop-row textarea{resize:vertical;min-height:60px;font-size:12px;}
.prop-row input[type=color]{width:100%;height:32px;padding:1px;border-radius:4px;border:1px solid #34495e;background:#1e2836;cursor:pointer;}
.prop-row input[type=range]{width:100%;cursor:pointer;accent-color:#1abc9c;}
.prop-lbl{display:flex;justify-content:space-between;font-size:10px;color:#95a5a6;text-transform:uppercase;margin-bottom:3px;}
.prop-lbl span{color:#e0e6ed;font-weight:bold;}

.fmt-btns{display:flex;gap:4px;flex-wrap:wrap;}
.fmt-btn{padding:4px 9px;background:#1e2836;border:1px solid #34495e;border-radius:4px;color:#e0e6ed;cursor:pointer;font-size:12px;font-weight:bold;transition:.12s;}
.fmt-btn:hover,.fmt-btn.active{background:#1abc9c;border-color:#1abc9c;color:#1e2836;}
.fmt-btn.danger{border-color:#e74c3c;color:#e74c3c;}
.fmt-btn.danger:hover{background:#e74c3c;color:#fff;}

.align-btns{display:flex;gap:3px;}
.align-btn{flex:1;padding:5px;background:#1e2836;border:1px solid #34495e;border-radius:4px;cursor:pointer;font-size:13px;text-align:center;transition:.12s;}
.align-btn:hover,.align-btn.active{background:#1abc9c;border-color:#1abc9c;}

.prop-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:12px;color:#556677;text-align:center;}
.prop-empty svg{opacity:.3;}
.prop-empty p{font-size:12px;line-height:1.6;}
.prop-add-btns{display:flex;gap:8px;}
.add-el-btn{padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:bold;color:#fff;transition:.15s;}
.add-el-btn:hover{filter:brightness(1.2);}

/* â”€â”€ LEFT: GLOBAL SETTINGS â”€â”€ */
#global-section{border-top:1px solid #1abc9c22;}
.glob-toggle{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;cursor:pointer;font-size:11px;color:#f1c40f;font-weight:bold;text-transform:uppercase;background:#1e2836;transition:.15s;}
.glob-toggle:hover{background:#253347;}
.glob-toggle .chev{font-size:9px;transition:transform .25s;}
.glob-toggle.open .chev{transform:rotate(90deg);}
#global-body{overflow:hidden;max-height:0;transition:max-height .35s ease;background:#1a252f;}
#global-body.open{max-height:1000px;}
#global-body-inner{padding:12px;}

/* â”€â”€ RIGHT: TOOLBAR â”€â”€ */
#canvas-toolbar{display:flex;align-items:center;gap:8px;padding:10px 16px;background:#1e2836;border-bottom:1px solid #1abc9c22;flex-shrink:0;flex-wrap:wrap;}
.ct-btn{padding:6px 12px;font-size:12px;font-weight:bold;border:none;border-radius:5px;cursor:pointer;color:#fff;transition:.15s;}
.ct-btn:hover{filter:brightness(1.15);}
.ct-text{background:#2980b9;}
.ct-img{background:#e67e22;}
.ct-download{background:#e74c3c;margin-left:auto;}
.ct-spacer{width:1px;height:20px;background:#1abc9c33;}
#canvas-nav{display:flex;align-items:center;gap:8px;font-size:12px;color:#95a5a6;}
.nav-btn{padding:4px 10px;background:#2c3e50;border:1px solid #34495e;border-radius:4px;cursor:pointer;color:#e0e6ed;font-size:13px;}
.nav-btn:hover{background:#34495e;}

/* â”€â”€ RIGHT: CANVAS AREA â”€â”€ */
#canvas-area{flex:1;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;}
#canvas-wrap{position:relative;transform-origin:center center;}
#live-canvas{width:375px;height:667px;position:relative;border-radius:8px;overflow:hidden;box-shadow:0 12px 50px rgba(0,0,0,.7);border:2px solid #2c3e50;}
#canvas-elements{position:absolute;inset:0;}

/* Drop overlay */
#drop-overlay{position:absolute;inset:0;background:rgba(26,188,156,.18);border:3px dashed #1abc9c;border-radius:8px;z-index:9999;display:none;align-items:center;justify-content:center;pointer-events:none;}
#drop-overlay.active{display:flex;}
#drop-overlay span{background:#1abc9c;color:#1e2836;padding:10px 22px;border-radius:30px;font-weight:bold;font-size:14px;}

/* Drive status */
#drive-status{position:absolute;bottom:8px;right:10px;font-size:10px;padding:3px 8px;border-radius:10px;background:#1e2836;border:1px solid #34495e;color:#7f8c8d;z-index:100;}
#drive-status.connected{border-color:#1abc9c;color:#1abc9c;}

/* â”€â”€ CANVAS ELEMENTS â”€â”€ */
.c-el{position:absolute;transform:translate(-50%,-50%);cursor:move;user-select:none;}
.c-el:hover .c-el-inner{outline:2px dashed #1abc9c55;}
.c-el.selected .c-el-inner{outline:2px solid #1abc9c !important;}
.c-el-inner{pointer-events:none;}
.c-el.editing .c-el-inner{pointer-events:auto;cursor:text;}
.c-el.editing .c-el-inner *{cursor:text;}

/* â”€â”€ SELECTION OVERLAY â”€â”€ */
#sel-overlay{position:absolute;pointer-events:none;z-index:500;display:none;}
#sel-overlay.visible{display:block;}
.sel-border{position:absolute;inset:0;border:2px solid #1abc9c;pointer-events:none;}
.sel-handle{position:absolute;width:10px;height:10px;background:#1abc9c;border:2px solid #1e2836;border-radius:2px;pointer-events:auto;z-index:10;}
.sel-handle.nw{top:-5px;left:-5px;cursor:nw-resize;}
.sel-handle.n{top:-5px;left:50%;transform:translateX(-50%);cursor:n-resize;}
.sel-handle.ne{top:-5px;right:-5px;cursor:ne-resize;}
.sel-handle.e{top:50%;right:-5px;transform:translateY(-50%);cursor:e-resize;}
.sel-handle.se{bottom:-5px;right:-5px;cursor:se-resize;}
.sel-handle.s{bottom:-5px;left:50%;transform:translateX(-50%);cursor:s-resize;}
.sel-handle.sw{bottom:-5px;left:-5px;cursor:sw-resize;}
.sel-handle.w{top:50%;left:-5px;transform:translateY(-50%);cursor:w-resize;}

/* â”€â”€ CROP OVERLAY â”€â”€ */
#crop-overlay{position:absolute;z-index:600;display:none;}
#crop-overlay.active{display:block;}
.crop-region{position:absolute;border:2px solid #f1c40f;box-shadow:0 0 0 9999px rgba(0,0,0,.45);}
.crop-h{position:absolute;width:100%;height:1px;background:#f1c40f55;}
.crop-handle{position:absolute;width:12px;height:12px;background:#f1c40f;border:2px solid #1e2836;border-radius:2px;pointer-events:auto;}
.crop-handle.c-nw{top:-6px;left:-6px;cursor:nw-resize;}
.crop-handle.c-ne{top:-6px;right:-6px;cursor:ne-resize;}
.crop-handle.c-sw{bottom:-6px;left:-6px;cursor:sw-resize;}
.crop-handle.c-se{bottom:-6px;right:-6px;cursor:se-resize;}
.crop-confirm{position:absolute;bottom:-34px;left:50%;transform:translateX(-50%);display:flex;gap:6px;}
.crop-confirm button{padding:4px 12px;border:none;border-radius:4px;cursor:pointer;font-size:11px;font-weight:bold;}

/* â”€â”€ CANVAS HINT PILL â”€â”€ */
#canvas-hint{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);color:#bdc3c7;font-size:10px;padding:4px 12px;border-radius:20px;pointer-events:none;white-space:nowrap;z-index:300;}

/* â”€â”€ SEPARATOR â”€â”€ */
.prop-sep{height:1px;background:#1abc9c22;margin:10px 0;}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LEFT PANE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="left-pane">
  <div id="left-top">
    <h1>ğŸ´ REVISION CARD STUDIO</h1>
    <div class="top-btns">
      <button class="tb tb-undo" id="btn-undo" onclick="undo()" disabled>â†©</button>
      <button class="tb tb-undo" id="btn-redo" onclick="redo()" disabled>â†ª</button>
      <label class="tb tb-load" style="cursor:pointer;">ğŸ“‚ Load
        <input type="file" accept=".html" style="display:none;" onchange="loadHTML(event)">
      </label>
    </div>
  </div>

  <!-- Cards list -->
  <div id="cards-list"></div>
  <div style="padding:0 10px 8px;">
    <button id="add-card-btn" onclick="addCard()">+ New Card</button>
  </div>

  <!-- Properties panel -->
  <div id="props-panel">
    <div class="prop-empty" id="prop-empty-state">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#1abc9c" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M8 12h8M12 8v8"/></svg>
      <p>Click any element on the canvas to edit its properties here</p>
      <div class="prop-add-btns">
        <button class="add-el-btn" style="background:#2980b9;" onclick="addTextToActive()">+ Text</button>
        <button class="add-el-btn" style="background:#e67e22;" onclick="addImgToActive()">+ Image</button>
      </div>
    </div>
    <div id="prop-content" style="display:none;"></div>
  </div>

  <!-- Global settings -->
  <div id="global-section">
    <div class="glob-toggle" id="glob-toggle" onclick="toggleGlobal()">
      <span>ğŸŒ Global Settings</span>
      <span class="chev">â–¶</span>
    </div>
    <div id="global-body">
      <div id="global-body-inner">
        <div class="prop-row">
          <label>Canvas Background</label>
          <input type="color" id="g-bg" value="#ffffff" oninput="updateGlobal('bg','color',this.value)">
        </div>
        <div class="prop-row">
          <label>BG Image URL</label>
          <input type="text" id="g-bgimg" placeholder="Optional URL..." oninput="updateGlobal('bg','imgUrl',this.value)">
        </div>
        <div class="prop-row">
          <label>Transition</label>
          <select id="g-trans" onchange="updateGlobal('transition','type',this.value)">
            <option value="fade">Fade</option><option value="slide">Slide</option><option value="zoom">Zoom</option><option value="none">None</option>
          </select>
        </div>
        <div class="prop-row">
          <label>Progress Bar</label>
          <select id="g-prog" onchange="updateGlobal('progress','show',this.value==='true')">
            <option value="true">Show</option><option value="false">Hide</option>
          </select>
        </div>
        <div class="prop-sep"></div>
        <div class="prop-row">
          <label>Custom Font URL (Google Fonts)</label>
          <input type="text" id="g-font-url" placeholder="https://fonts.googleapis.com/..." oninput="updateGlobal('customFont','url',this.value);applyFontLink(this.value)">
        </div>
        <div class="prop-row">
          <label>Custom Font Name</label>
          <input type="text" id="g-font-name" placeholder="e.g. Nunito" oninput="updateGlobal('customFont','name',this.value)">
        </div>
        <div class="prop-sep"></div>
        <div class="prop-row">
          <label>Logo URL</label>
          <input type="text" id="g-logo-url" placeholder="Logo URL..." oninput="updateGlobal('logo','url',this.value)">
        </div>
        <div class="prop-row">
          <div class="prop-lbl"><span>Logo Width</span><span id="g-logo-w-v">25%</span></div>
          <input type="range" id="g-logo-w" min="5" max="80" value="25" oninput="updateGlobal('logo','width',+this.value);document.getElementById('g-logo-w-v').textContent=this.value+'%'">
        </div>
        <div class="prop-sep"></div>
        <div style="font-size:11px;color:#f1c40f;font-weight:bold;margin-bottom:8px;">GOOGLE DRIVE UPLOAD</div>
        <div class="prop-row">
          <label>OAuth Client ID</label>
          <input type="text" id="drive-client-id" placeholder="xxxx.apps.googleusercontent.com" oninput="globalConfig.drive={...globalConfig.drive,clientId:this.value}">
        </div>
        <div class="prop-row">
          <label>Target Folder ID (optional)</label>
          <input type="text" id="drive-folder-id" placeholder="Drive folder ID..." oninput="globalConfig.drive={...globalConfig.drive,folderId:this.value}">
        </div>
        <button class="add-el-btn" style="background:#4285f4;width:100%;padding:7px;" onclick="connectDrive()">
          <span id="drive-btn-label">ğŸ”— Connect Google Drive</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RIGHT PANE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="right-pane">
  <div id="canvas-toolbar">
    <button class="ct-btn ct-text" onclick="addTextToActive()">ï¼‹ Text</button>
    <button class="ct-btn ct-img" onclick="addImgToActive()">ï¼‹ Image</button>
    <div class="ct-spacer"></div>
    <div id="canvas-nav">
      <button class="nav-btn" onclick="prevCard()">â€¹</button>
      <span id="card-counter">Card 1 / 1</span>
      <button class="nav-btn" onclick="nextCard()">â€º</button>
    </div>
    <button class="ct-btn ct-download" onclick="downloadHTML()">â¬‡ Download</button>
  </div>

  <div id="canvas-area">
    <div id="canvas-wrap">
      <div id="live-canvas">
        <div id="canvas-elements"></div>
        <!-- Selection overlay -->
        <div id="sel-overlay">
          <div class="sel-border"></div>
          <div class="sel-handle nw" data-h="nw"></div>
          <div class="sel-handle n" data-h="n"></div>
          <div class="sel-handle ne" data-h="ne"></div>
          <div class="sel-handle e" data-h="e"></div>
          <div class="sel-handle se" data-h="se"></div>
          <div class="sel-handle s" data-h="s"></div>
          <div class="sel-handle sw" data-h="sw"></div>
          <div class="sel-handle w" data-h="w"></div>
        </div>
        <!-- Crop overlay (inside canvas so it scales with it) -->
        <div id="crop-overlay">
          <div id="crop-region" class="crop-region">
            <div class="crop-handle c-nw" data-ch="nw"></div>
            <div class="crop-handle c-ne" data-ch="ne"></div>
            <div class="crop-handle c-sw" data-ch="sw"></div>
            <div class="crop-handle c-se" data-ch="se"></div>
            <div class="crop-confirm">
              <button style="background:#1abc9c;color:#1e2836;" onclick="confirmCrop()">âœ“ Apply</button>
              <button style="background:#e74c3c;color:#fff;" onclick="cancelCrop()">âœ•</button>
            </div>
          </div>
        </div>
        <div id="drop-overlay"><span>ğŸ“¸ Drop image here</span></div>
      </div>
      <div id="canvas-hint">Click to select Â· Double-click text to edit Â· Drag to move Â· Drop image to add</div>
    </div>
    <div id="drive-status">Drive: Not connected</div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_FONTS = ['Arial','Roboto','Montserrat','Poppins','Oswald','Lora','Comic Neue','Courier Prime'];
const ALIGNS = ['left','center','right','justify'];

let activeCardIdx = 0;
let sel = { type:null, ci:null, idx:null }; // selected element
let editingEl = null; // DOM element currently in text-edit mode

let globalConfig = {
  bg:{color:'#ffffff',imgUrl:''},
  progress:{show:true},
  transition:{type:'fade'},
  customFont:{url:'',name:''},
  logo:{url:'',width:25,x:50,y:92},
  drive:{clientId:'',folderId:''}
};

let cardData = [{
  type:'revision',
  header:{text:'Electrochemistry',font:'Arial',size:22,color:'#ffffff',bgColor:'#3498db',bgAlpha:100,x:50,y:7,width:90,borderW:0,borderC:'#000',borderR:8,shadowBlur:0,shadowAlpha:50,shadowColor:'#000'},
  texts:[{text:'Tap to edit this text box',font:'Arial',size:17,x:50,y:44,align:'center',color:'#2c3e50',weight:'normal',lineSpace:1.5,width:85}],
  imgs:[{url:'',width:40,x:50,y:74,crop:{t:0,r:0,b:0,l:0}}]
}];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNDO / REDO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let hist=[], histIdx=-1, histTimer=null;

function pushHist() {
  clearTimeout(histTimer);
  histTimer = setTimeout(()=>{
    hist = hist.slice(0,histIdx+1);
    hist.push(JSON.parse(JSON.stringify({cardData,globalConfig})));
    if(hist.length>60)hist.shift();
    histIdx = hist.length-1;
    updUndoBtns();
  },350);
}

function undo() {
  clearTimeout(histTimer);
  if(histIdx===hist.length-1){hist.push(JSON.parse(JSON.stringify({cardData,globalConfig})));histIdx=hist.length-1;}
  if(histIdx>0){histIdx--;const s=hist[histIdx];cardData=JSON.parse(JSON.stringify(s.cardData));globalConfig=JSON.parse(JSON.stringify(s.globalConfig));if(activeCardIdx>=cardData.length)activeCardIdx=Math.max(0,cardData.length-1);deselectEl();renderAll();}
  updUndoBtns();
}

function redo() {
  clearTimeout(histTimer);
  if(histIdx<hist.length-1){histIdx++;const s=hist[histIdx];cardData=JSON.parse(JSON.stringify(s.cardData));globalConfig=JSON.parse(JSON.stringify(s.globalConfig));deselectEl();renderAll();}
  updUndoBtns();
}

function updUndoBtns() {
  document.getElementById('btn-undo').disabled=histIdx<=0;
  document.getElementById('btn-redo').disabled=histIdx>=hist.length-1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e=>{
  const editing = document.activeElement?.contentEditable==='true' || ['INPUT','TEXTAREA','SELECT'].includes(document.activeElement?.tagName);
  if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();undo();return;}
  if((e.ctrlKey||e.metaKey)&&(e.key==='y'||(e.shiftKey&&e.key==='z'))){e.preventDefault();redo();return;}
  if(e.key==='Escape'){exitEditMode();deselectEl();return;}
  if((e.key==='Delete'||e.key==='Backspace')&&sel.type&&!editing){e.preventDefault();deleteSelected();return;}
  if(!editing){
    if(e.key==='ArrowRight'){e.preventDefault();nextCard();}
    if(e.key==='ArrowLeft'){e.preventDefault();prevCard();}
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS SCALE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getScale() {
  const area = document.getElementById('canvas-area');
  return Math.min((area.clientWidth-40)/375,(area.clientHeight-40)/667);
}

function resizeCanvas() {
  const wrap = document.getElementById('canvas-wrap');
  const s = getScale();
  wrap.style.transform = `scale(${s})`;
}
window.addEventListener('resize',()=>{resizeCanvas();updateSelOverlay();});

function clientToCanvas(cx,cy) {
  const rect = document.getElementById('live-canvas').getBoundingClientRect();
  const s = getScale();
  return { x:(cx-rect.left)/s, y:(cy-rect.top)/s };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG & DROP IMAGE ON CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const liveCanvas = ()=>document.getElementById('live-canvas');

liveCanvas;
document.addEventListener('DOMContentLoaded',()=>{
  const lc = document.getElementById('live-canvas');
  lc.addEventListener('dragover',e=>{e.preventDefault();document.getElementById('drop-overlay').classList.add('active');});
  lc.addEventListener('dragleave',e=>{if(!lc.contains(e.relatedTarget))document.getElementById('drop-overlay').classList.remove('active');});
  lc.addEventListener('drop',e=>{
    e.preventDefault();
    document.getElementById('drop-overlay').classList.remove('active');
    const file = [...(e.dataTransfer.files||[])].find(f=>f.type.startsWith('image/'));
    if(!file)return;
    const pos = clientToCanvas(e.clientX,e.clientY);
    const xPct = Math.round(pos.x/375*100);
    const yPct = Math.round(pos.y/667*100);
    handleImageDrop(file,xPct,yPct);
  });
});

async function handleImageDrop(file,x,y) {
  // Try Drive upload first, fall back to base64
  if(driveToken) {
    try {
      const url = await uploadToDrive(file);
      insertImage(url,x,y);
      return;
    } catch(e) { console.warn('Drive upload failed, using base64',e); }
  }
  // Base64 fallback
  const reader = new FileReader();
  reader.onload = ev => insertImage(ev.target.result,x,y);
  reader.readAsDataURL(file);
}

function insertImage(url,x,y) {
  const card = cardData[activeCardIdx];
  card.imgs.push({url,width:55,x,y,crop:{t:0,r:0,b:0,l:0}});
  pushHist();
  renderCanvas();
  // Auto-select the new image
  const idx = card.imgs.length-1;
  selectEl('img',activeCardIdx,idx);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE DRIVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tokenClient=null, driveToken=null;

function connectDrive() {
  const clientId = document.getElementById('drive-client-id').value.trim();
  if(!clientId)return alert('Enter your OAuth Client ID first (in Global Settings).');
  if(typeof google==='undefined')return alert('Google Identity Services not loaded. Check your internet connection.');
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id:clientId,
    scope:'https://www.googleapis.com/auth/drive.file',
    callback:(resp)=>{
      if(resp.error){alert('Drive auth failed: '+resp.error);return;}
      driveToken = resp.access_token;
      document.getElementById('drive-status').textContent='Drive: Connected âœ“';
      document.getElementById('drive-status').classList.add('connected');
      document.getElementById('drive-btn-label').textContent='âœ“ Drive Connected';
    }
  });
  tokenClient.requestAccessToken();
}

async function uploadToDrive(file) {
  const folderId = (globalConfig.drive?.folderId||'').trim();
  const meta = {name:file.name,mimeType:file.type};
  if(folderId) meta.parents=[folderId];
  const form = new FormData();
  form.append('metadata',new Blob([JSON.stringify(meta)],{type:'application/json'}));
  form.append('file',file);
  const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{
    method:'POST',headers:{Authorization:`Bearer ${driveToken}`},body:form
  });
  const data = await res.json();
  if(!data.id)throw new Error('No file ID returned');
  // Make public
  await fetch(`https://www.googleapis.com/drive/v3/files/${data.id}/permissions`,{
    method:'POST',headers:{Authorization:`Bearer ${driveToken}`,'Content-Type':'application/json'},
    body:JSON.stringify({role:'reader',type:'anyone'})
  });
  return `https://drive.google.com/thumbnail?id=${data.id}&sz=w1000`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hexToRgba(h,a){let r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return`rgba(${r},${g},${b},${a/100})`;}
function convDrive(url){if(!url)return'';if(url.startsWith('data:'))return url;if(url.includes('drive.google.com')){const m=url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/)||url.match(/\/d\/([a-zA-Z0-9_-]+)/)||url.match(/id=([a-zA-Z0-9_-]+)/);if(m&&m[1])return`https://drive.google.com/thumbnail?id=${m[1]}&sz=w1000`;}return url;}
function getFonts(){const f=[...DEFAULT_FONTS];if(globalConfig.customFont?.name&&!f.includes(globalConfig.customFont.name))f.push(globalConfig.customFont.name);return f;}
function getCard(){return cardData[activeCardIdx];}

function applyFontLink(url){
  if(!url)return;
  let el=document.getElementById('cf-link');
  if(!el){el=document.createElement('link');el.id='cf-link';el.rel='stylesheet';document.head.appendChild(el);}
  el.href=url;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARD NAV & OPERATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nextCard(){if(activeCardIdx<cardData.length-1){deselectEl();activeCardIdx++;renderAll();}}
function prevCard(){if(activeCardIdx>0){deselectEl();activeCardIdx--;renderAll();}}

function addCard(){
  cardData.push({type:'revision',
    header:{text:'New Topic',font:'Arial',size:22,color:'#fff',bgColor:'#3498db',bgAlpha:100,x:50,y:7,width:90,borderW:0,borderC:'#000',borderR:8,shadowBlur:0,shadowAlpha:50,shadowColor:'#000'},
    texts:[{text:'Content here...',font:'Arial',size:17,x:50,y:44,align:'center',color:'#2c3e50',weight:'normal',lineSpace:1.5,width:85}],
    imgs:[{url:'',width:40,x:50,y:74,crop:{t:0,r:0,b:0,l:0}}]
  });
  activeCardIdx=cardData.length-1;deselectEl();pushHist();renderAll();
}

function deleteCard(ci,e){
  e&&e.stopPropagation();
  if(cardData.length===1)return alert('Must have at least one card.');
  cardData.splice(ci,1);
  if(activeCardIdx>=cardData.length)activeCardIdx=Math.max(0,cardData.length-1);
  deselectEl();pushHist();renderAll();
}

function duplicateCard(ci,e){
  e&&e.stopPropagation();
  const clone=JSON.parse(JSON.stringify(cardData[ci]));
  clone.header.text+=' (Copy)';
  cardData.splice(ci+1,0,clone);
  activeCardIdx=ci+1;deselectEl();pushHist();renderAll();
}

function addTextToActive(){
  getCard().texts.push({text:'New text box',font:'Arial',size:17,x:50,y:50,align:'center',color:'#2c3e50',weight:'normal',lineSpace:1.5,width:80});
  pushHist();renderCanvas();
  const idx=getCard().texts.length-1;
  selectEl('text',activeCardIdx,idx);
}

function addImgToActive(){
  getCard().imgs.push({url:'',width:50,x:50,y:60,crop:{t:0,r:0,b:0,l:0}});
  pushHist();renderCanvas();
  const idx=getCard().imgs.length-1;
  selectEl('img',activeCardIdx,idx);
}

function deleteSelected(){
  if(!sel.type)return;
  const card=getCard();
  if(sel.type==='text'&&card.texts.length>0)card.texts.splice(sel.idx,1);
  else if(sel.type==='img')card.imgs.splice(sel.idx,1);
  else if(sel.type==='header')card.header.text=''; // just clear
  deselectEl();pushHist();renderCanvas();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SELECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectEl(type,ci,idx){
  exitEditMode();
  sel={type,ci,idx};
  document.querySelectorAll('.c-el').forEach(el=>el.classList.remove('selected'));
  const el=getElDOM(type,idx);
  if(el){el.classList.add('selected');updateSelOverlay();}
  renderPropsPanel();
}

function deselectEl(){
  exitEditMode();
  sel={type:null,ci:null,idx:null};
  document.querySelectorAll('.c-el').forEach(el=>el.classList.remove('selected'));
  document.getElementById('sel-overlay').classList.remove('visible');
  renderPropsPanel();
}

function getElDOM(type,idx){
  if(type==='header')return document.querySelector('.c-el[data-type="header"]');
  if(type==='text')return document.querySelector(`.c-el[data-type="text"][data-idx="${idx}"]`);
  if(type==='img')return document.querySelector(`.c-el[data-type="img"][data-idx="${idx}"]`);
  return null;
}

function updateSelOverlay(){
  if(!sel.type)return;
  const el=getElDOM(sel.type,sel.idx);
  if(!el){document.getElementById('sel-overlay').classList.remove('visible');return;}
  const canvas=document.getElementById('live-canvas');
  const cr=canvas.getBoundingClientRect(), er=el.getBoundingClientRect();
  const s=getScale();
  const ov=document.getElementById('sel-overlay');
  ov.style.left=((er.left-cr.left)/s)+'px';
  ov.style.top=((er.top-cr.top)/s)+'px';
  ov.style.width=(er.width/s)+'px';
  ov.style.height=(er.height/s)+'px';
  ov.classList.add('visible');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INLINE TEXT EDITING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function enterEditMode(el) {
  if(editingEl===el)return;
  exitEditMode();
  editingEl=el;
  el.classList.add('editing');
  const inner=el.querySelector('.c-el-inner');
  inner.contentEditable='true';
  inner.focus();
  // hide sel overlay handles while editing
  const ov=document.getElementById('sel-overlay');
  ov.querySelectorAll('.sel-handle').forEach(h=>h.style.visibility='hidden');
  el.style.cursor='text';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FONT UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Google Fonts name â†’ URL param mapping
const GFONT_MAP = {
  'Roboto':        'Roboto:wght@400;700',
  'Montserrat':    'Montserrat:wght@400;700;900',
  'Poppins':       'Poppins:wght@400;700;900',
  'Oswald':        'Oswald:wght@400;700',
  'Lora':          'Lora:ital,wght@0,400;0,700;1,400;1,700',
  'Comic Neue':    'Comic+Neue:wght@400;700',
  'Courier Prime': 'Courier+Prime:wght@400;700'
};

// Fonts that are system fonts â€” no Google Fonts loading needed
const SYSTEM_FONTS = new Set(['Arial','Helvetica','Times New Roman','Times','Georgia','Verdana',
  'Trebuchet MS','Impact','Courier New','Courier','monospace','sans-serif','serif']);

/**
 * Scan all cardData and extract every font name that is actually used,
 * including any font-family references buried inside rich text innerHTML.
 */
function collectAllUsedFonts() {
  const fonts = new Set();
  const addFont = f => { if(f) fonts.add(f.trim().replace(/['"]/g,'')); };

  cardData.forEach(card => {
    addFont(card.header?.font);
    card.texts?.forEach(t => {
      addFont(t.font);
      // Also scan rich text HTML for any inline font-family / <font face> tags
      if (t.text) {
        const tmp = document.createElement('div');
        tmp.innerHTML = t.text;
        tmp.querySelectorAll('[face]').forEach(el => addFont(el.getAttribute('face')));
        tmp.querySelectorAll('[style]').forEach(el => {
          const fm = el.style.fontFamily;
          if (fm) fm.split(',').forEach(f => addFont(f));
        });
      }
    });
  });

  if (globalConfig.customFont?.name) addFont(globalConfig.customFont.name);
  return fonts;
}

/**
 * Build a single Google Fonts <link> tag covering all fonts used in the project.
 * Falls back to the full default set so nothing is ever missing.
 */
function buildFontLink() {
  const used = collectAllUsedFonts();

  // Always include the full default set as a safety net
  const defaultFamilies = Object.values(GFONT_MAP);
  const familyParams = new Set(defaultFamilies);

  // Add any custom Google Font
  if (globalConfig.customFont?.url) {
    // Return two link tags: one for defaults, one for custom
    const base = `https://fonts.googleapis.com/css2?${[...familyParams].map(f=>'family='+f).join('&')}&display=swap`;
    return `<link href="${base}" rel="stylesheet">\n    <link href="${globalConfig.customFont.url}" rel="stylesheet">`;
  }

  const base = `https://fonts.googleapis.com/css2?${[...familyParams].map(f=>'family='+f).join('&')}&display=swap`;
  return `<link href="${base}" rel="stylesheet">`;
}

/**
 * Sanitize raw innerHTML from contentEditable before storing or exporting.
 *
 * Problems this fixes:
 * 1. Chrome auto-wraps text in <span style="font-family:Arial;font-size:17px;color:...">
 *    when you apply bold/colour â€” those inline font-family values override the parent.
 * 2. document.execCommand generates <font face="..."> tags instead of CSS.
 * 3. Inline font-size and color styles that duplicate the base text box settings.
 *
 * Strategy: strip font-family from inline styles when it matches the base font
 * (browser auto-inserted), and convert <font face> to proper CSS spans.
 * Intentional font-family changes (different from base) are preserved.
 */
function sanitizeRichHTML(html, baseFont) {
  if (!html) return html;
  const tmp = document.createElement('div');
  tmp.innerHTML = html;

  // 1. Convert all <font face="X"> to <span style="font-family:'X'">
  tmp.querySelectorAll('font[face]').forEach(el => {
    const span = document.createElement('span');
    const face = el.getAttribute('face');
    // Copy existing inline style if any
    let styleStr = el.getAttribute('style') || '';
    // Prepend font-family
    styleStr = `font-family:'${face}';${styleStr}`;
    span.setAttribute('style', styleStr);
    while (el.firstChild) span.appendChild(el.firstChild);
    // Copy other <font> attributes like size/color
    if (el.getAttribute('color')) span.style.color = el.getAttribute('color');
    el.replaceWith(span);
  });

  // 2. Remove auto-inserted font-family that matches the base font (or is a generic fallback)
  //    and remove auto-inserted font-size that duplicates the parent.
  const normalise = f => (f||'').toLowerCase().replace(/['"]/g,'').trim().split(',')[0].trim();
  const baseNorm = normalise(baseFont);

  tmp.querySelectorAll('[style]').forEach(el => {
    const fm = el.style.fontFamily;
    if (fm) {
      const fmNorm = normalise(fm);
      // Remove if it's the same as base (browser-injected noise) OR if it's a generic keyword
      const genericFallbacks = ['inherit','initial','unset','-webkit-standard','times new roman','times'];
      if (fmNorm === baseNorm || genericFallbacks.includes(fmNorm)) {
        el.style.removeProperty('font-family');
      }
      // If it differs from base, keep it â€” user intentionally changed font inline
    }
    // Remove auto-injected font-size if it's the only thing left and it duplicates parent
    // (we can't know the exact px here so we leave font-size alone â€” only clean font-family)

    // Clean up empty style attributes
    if (!el.getAttribute('style') || el.getAttribute('style').trim() === '') {
      el.removeAttribute('style');
    }
  });

  // 3. Remove empty <span> wrappers that do nothing (browser litter)
  tmp.querySelectorAll('span:not([style]):not([class])').forEach(el => {
    while (el.firstChild) el.parentNode.insertBefore(el.firstChild, el);
    el.remove();
  });

  return tmp.innerHTML;
}

function exitEditMode(){
  if(!editingEl)return;
  const inner=editingEl.querySelector('.c-el-inner');
  if(!inner)return;
  inner.contentEditable='false';
  // Save text back to data
  const type=editingEl.dataset.type, idx=parseInt(editingEl.dataset.idx)||0;
  const card=cardData[activeCardIdx];
  if(type==='text'&&card.texts[idx]!==undefined){
    // Sanitize: strip browser-injected font-family noise before storing
    card.texts[idx].text = sanitizeRichHTML(inner.innerHTML, card.texts[idx].font);
    // Update the DOM to reflect cleaned HTML
    inner.innerHTML = card.texts[idx].text;
    pushHist();
  }
  else if(type==='header'){card.header.text=inner.textContent;pushHist();}
  editingEl.classList.remove('editing');
  editingEl.style.cursor='move';
  editingEl=null;
  // Restore sel overlay
  document.getElementById('sel-overlay').querySelectorAll('.sel-handle').forEach(h=>h.style.visibility='');
  // No full re-render needed since DOM already has the content
  renderCardsList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS DRAG (MOVE) â€” for elements
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let moveDrag={active:false,type:null,idx:null,el:null,ox:0,oy:0,startData:{x:0,y:0}};

function startMove(e,type,idx,el){
  if(e.target.classList.contains('sel-handle')||e.target.classList.contains('crop-handle'))return;
  if(editingEl)return;
  e.preventDefault();
  e.stopPropagation();
  selectEl(type,activeCardIdx,idx);
  const canvas=document.getElementById('live-canvas');
  const rect=canvas.getBoundingClientRect();
  const s=getScale();
  const item=getItem(type,idx);
  moveDrag={active:true,type,idx,el,
    ox:e.clientX,oy:e.clientY,
    startData:{x:parseFloat(item.x)||50,y:parseFloat(item.y)||50},
    cW:375,cH:667
  };
}

document.addEventListener('mousemove',e=>{
  if(moveDrag.active){
    const s=getScale();
    const dx=(e.clientX-moveDrag.ox)/s/375*100;
    const dy=(e.clientY-moveDrag.oy)/s/667*100;
    const nx=Math.max(0,Math.min(100,moveDrag.startData.x+dx));
    const ny=Math.max(0,Math.min(100,moveDrag.startData.y+dy));
    moveDrag.el.style.left=nx+'%';
    moveDrag.el.style.top=ny+'%';
    updateSelOverlay();
  }
  if(resizeDrag.active) handleResizeDrag(e);
  if(cropDrag.active) handleCropDragMove(e);
});

document.addEventListener('mouseup',e=>{
  if(moveDrag.active){
    const s=getScale();
    const dx=(e.clientX-moveDrag.ox)/s/375*100;
    const dy=(e.clientY-moveDrag.oy)/s/667*100;
    const nx=Math.round(Math.max(0,Math.min(100,moveDrag.startData.x+dx)));
    const ny=Math.round(Math.max(0,Math.min(100,moveDrag.startData.y+dy)));
    setItemPos(moveDrag.type,moveDrag.idx,nx,ny);
    moveDrag.active=false;
    pushHist();renderPropsPanel();updateSelOverlay();
  }
  if(resizeDrag.active){resizeDrag.active=false;pushHist();renderPropsPanel();updateSelOverlay();}
  if(cropDrag.active){cropDrag.active=false;}
});

function getItem(type,idx){
  const card=getCard();
  if(type==='header')return card.header;
  if(type==='text')return card.texts[idx];
  if(type==='img')return card.imgs[idx];
}

function setItemPos(type,idx,x,y){
  const item=getItem(type,idx);
  if(item){item.x=x;item.y=y;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESIZE DRAG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let resizeDrag={active:false,handle:'',startW:0,startX:0,startMouseX:0};

document.getElementById('sel-overlay').querySelectorAll('.sel-handle').forEach(h=>{
  h.addEventListener('mousedown',e=>{
    e.stopPropagation();e.preventDefault();
    if(!sel.type)return;
    const item=getItem(sel.type,sel.idx);
    resizeDrag={active:true,handle:h.dataset.h,startW:parseFloat(item.width)||80,startX:parseFloat(item.x)||50,startMouseX:e.clientX};
  });
});

function handleResizeDrag(e){
  if(!resizeDrag.active||!sel.type)return;
  const s=getScale();
  const dx=(e.clientX-resizeDrag.startMouseX)/s/375*100;
  const item=getItem(sel.type,sel.idx);
  const h=resizeDrag.handle;
  let newW=resizeDrag.startW;
  if(h.includes('e'))newW=Math.max(10,Math.min(100,resizeDrag.startW+dx*2));
  else if(h.includes('w'))newW=Math.max(10,Math.min(100,resizeDrag.startW-dx*2));
  else if(h==='se'||h==='sw'||h==='ne'||h==='nw')newW=Math.max(10,Math.min(100,resizeDrag.startW+dx*2));
  item.width=Math.round(newW);
  // Update DOM directly for responsiveness
  const el=getElDOM(sel.type,sel.idx);
  if(el)el.style.width=item.width+'%';
  updateSelOverlay();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CROP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cropState={ci:null,idx:null,t:0,r:0,b:0,l:0,imgRect:{x:0,y:0,w:0,h:0}};
let cropDrag={active:false,handle:'',startT:0,startR:0,startB:0,startL:0,startMX:0,startMY:0};

function startCrop(){
  if(sel.type!=='img')return;
  const card=getCard();
  const img=card.imgs[sel.idx];
  const el=getElDOM('img',sel.idx);
  if(!el)return;
  const s=getScale();
  const canvas=document.getElementById('live-canvas');
  const cr=canvas.getBoundingClientRect(), er=el.getBoundingClientRect();
  const x=(er.left-cr.left)/s, y=(er.top-cr.top)/s;
  const w=er.width/s, h=er.height/s;
  cropState={ci:activeCardIdx,idx:sel.idx,
    t:img.crop?.t||0,r:img.crop?.r||0,b:img.crop?.b||0,l:img.crop?.l||0,
    imgRect:{x,y,w,h}};
  positionCropOverlay();
  document.getElementById('crop-overlay').classList.add('active');
}

function positionCropOverlay(){
  const {t,r,b,l,imgRect:{x,y,w,h}}=cropState;
  const region=document.getElementById('crop-region');
  const co=document.getElementById('crop-overlay');
  co.style.left=x+'px'; co.style.top=y+'px'; co.style.width=w+'px'; co.style.height=h+'px';
  region.style.left=(l/100*w)+'px'; region.style.top=(t/100*h)+'px';
  region.style.width=((1-(l+r)/100)*w)+'px'; region.style.height=((1-(t+b)/100)*h)+'px';
}

document.querySelectorAll('.crop-handle').forEach(ch=>{
  ch.addEventListener('mousedown',e=>{
    e.stopPropagation();e.preventDefault();
    cropDrag={active:true,handle:ch.dataset.ch,
      startT:cropState.t,startR:cropState.r,startB:cropState.b,startL:cropState.l,
      startMX:e.clientX,startMY:e.clientY};
  });
});

function handleCropDragMove(e){
  const s=getScale();
  const {imgRect:{w,h}}=cropState;
  const dx=(e.clientX-cropDrag.startMX)/s/w*100;
  const dy=(e.clientY-cropDrag.startMY)/s/h*100;
  const ch=cropDrag.handle;
  if(ch.includes('n'))cropState.t=Math.max(0,Math.min(90,cropDrag.startT+dy));
  if(ch.includes('s'))cropState.b=Math.max(0,Math.min(90,cropDrag.startB-dy));
  if(ch.includes('w'))cropState.l=Math.max(0,Math.min(90,cropDrag.startL+dx));
  if(ch.includes('e'))cropState.r=Math.max(0,Math.min(90,cropDrag.startR-dx));
  positionCropOverlay();
}

function confirmCrop(){
  const {ci,idx,t,r,b,l}=cropState;
  cardData[ci].imgs[idx].crop={t,r,b,l};
  document.getElementById('crop-overlay').classList.remove('active');
  pushHist();renderCanvas();updateSelOverlay();
}

function cancelCrop(){
  document.getElementById('crop-overlay').classList.remove('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL CONFIG UPDATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateGlobal(sec,field,val){
  if(!globalConfig[sec])globalConfig[sec]={};
  globalConfig[sec][field]=val;
  pushHist();renderCanvas();
}

function toggleGlobal(){
  const t=document.getElementById('glob-toggle'),b=document.getElementById('global-body');
  t.classList.toggle('open');b.classList.toggle('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCanvas(){
  const lc=document.getElementById('live-canvas');
  // Background
  const bgUrl=convDrive(globalConfig.bg.imgUrl);
  if(bgUrl){lc.style.backgroundImage=`url('${bgUrl}')`;lc.style.backgroundSize='cover';lc.style.backgroundPosition='center';}
  else{lc.style.backgroundImage='none';lc.style.backgroundColor=globalConfig.bg.color;}

  const cont=document.getElementById('canvas-elements');
  cont.innerHTML='';

  const card=getCard();

  // Progress bar
  if(globalConfig.progress.show){
    const p=document.createElement('div');
    p.style.cssText=`position:absolute;top:0;left:0;height:6px;background:#3498db;z-index:200;width:${((activeCardIdx+1)/cardData.length)*100}%;pointer-events:none;`;
    cont.appendChild(p);
  }

  // Logo
  const lUrl=convDrive(globalConfig.logo.url);
  if(lUrl){
    const ld=document.createElement('div');
    ld.style.cssText=`position:absolute;left:${globalConfig.logo.x}%;top:${globalConfig.logo.y}%;width:${globalConfig.logo.width}%;transform:translate(-50%,-50%);z-index:10;pointer-events:none;`;
    ld.innerHTML=`<img src="${lUrl}" style="width:100%;height:auto;display:block;">`;
    cont.appendChild(ld);
  }

  // Header
  if(card.header){
    const h=card.header;
    const bg=hexToRgba(h.bgColor,h.bgAlpha);
    const shadow=(h.shadowBlur||0)>0?`box-shadow:0 4px ${h.shadowBlur}px ${hexToRgba(h.shadowColor||'#000',h.shadowAlpha||50)};`:'';
    const border=(h.borderW||0)>0?`border:${h.borderW}px solid ${h.borderC||'#000'};`:'';
    const el=makeEl('header',-1);
    el.style.cssText+=`left:${h.x}%;top:${h.y}%;width:${h.width}%;z-index:15;`;
    el.querySelector('.c-el-inner').style.cssText=`background:${bg};color:${h.color};font-family:'${h.font}';font-size:${h.size}px;font-weight:bold;text-align:center;padding:10px 14px;border-radius:${h.borderR||8}px;${border}${shadow}line-height:1.3;word-break:break-word;`;
    el.querySelector('.c-el-inner').textContent=h.text;
    cont.appendChild(el);
  }

  // Text boxes
  card.texts.forEach((t,i)=>{
    const el=makeEl('text',i);
    el.style.cssText+=`left:${t.x}%;top:${t.y}%;width:${t.width||85}%;z-index:5;`;
    const inner=el.querySelector('.c-el-inner');
    inner.style.cssText=`font-family:'${t.font}';font-size:${t.size}px;font-weight:${t.weight};color:${t.color};text-align:${t.align};line-height:${t.lineSpace};word-break:break-word;`;
    inner.innerHTML=t.text;
    cont.appendChild(el);
  });

  // Images
  card.imgs.forEach((img,i)=>{
    if(!img.url)return;
    const el=makeEl('img',i);
    el.style.cssText+=`left:${img.x}%;top:${img.y}%;width:${img.width}%;z-index:8;`;
    const crop=img.crop||{t:0,r:0,b:0,l:0};
    const inner=el.querySelector('.c-el-inner');
    inner.style.cssText=`overflow:hidden;border-radius:6px;`;
    const clipPath=`inset(${crop.t}% ${crop.r}% ${crop.b}% ${crop.l}%)`;
    inner.innerHTML=`<img src="${convDrive(img.url)}" style="width:100%;height:auto;display:block;clip-path:${clipPath};border-radius:6px;">`;
    cont.appendChild(el);
  });

  // Re-apply selection
  if(sel.type){
    setTimeout(()=>{
      const el=getElDOM(sel.type,sel.idx);
      if(el){el.classList.add('selected');updateSelOverlay();}
    },0);
  }
}

function makeEl(type,idx){
  const el=document.createElement('div');
  el.className='c-el';
  el.dataset.type=type;
  el.dataset.idx=idx;
  el.innerHTML='<div class="c-el-inner"></div>';

  // Click = select
  el.addEventListener('mousedown',e=>{
    if(e.target.classList.contains('sel-handle'))return;
    if(editingEl&&editingEl!==el){exitEditMode();}
    if(!editingEl){
      selectEl(type,activeCardIdx,idx);
      if(type!=='img')startMove(e,type,idx,el);
    }
  });

  // Double-click = edit text
  el.addEventListener('dblclick',e=>{
    if(type==='img'){startCrop();return;}
    enterEditMode(el);
  });

  // Prevent canvas-click from deselecting when clicking element
  el.addEventListener('click',e=>e.stopPropagation());

  return el;
}

// Click canvas background = deselect
document.getElementById('canvas-elements').addEventListener('mousedown',e=>{
  if(e.target===document.getElementById('canvas-elements')||e.target===document.getElementById('live-canvas')){deselectEl();}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROPERTIES PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPropsPanel(){
  const empty=document.getElementById('prop-empty-state');
  const content=document.getElementById('prop-content');
  if(!sel.type){empty.style.display='flex';content.style.display='none';return;}
  empty.style.display='none';content.style.display='block';
  const fonts=getFonts();

  if(sel.type==='header'){
    const h=getCard().header;
    content.innerHTML=`
    <h3>ğŸ“Œ Header Properties</h3>
    <div class="prop-row"><div class="prop-lbl"><span>Font Family</span></div>
      <select onchange="getCard().header.font=this.value;pushHist();renderCanvas();">${fonts.map(f=>`<option value="${f}" ${f===h.font?'selected':''}>${f}</option>`).join('')}</select></div>
    <div class="prop-row"><div class="prop-lbl"><span>Font Size</span><span>${h.size}px</span></div>
      <input type="range" min="10" max="60" value="${h.size}" oninput="getCard().header.size=+this.value;this.previousElementSibling.querySelector('span:last-child').textContent=this.value+'px';renderCanvas();updateSelOverlay();" onchange="pushHist()"></div>
    <div class="prop-row"><label>Text Color</label>
      <input type="color" value="${h.color}" oninput="getCard().header.color=this.value;renderCanvas();" onchange="pushHist()"></div>
    <div class="prop-row"><label>Background Color</label>
      <input type="color" value="${h.bgColor}" oninput="getCard().header.bgColor=this.value;renderCanvas();" onchange="pushHist()"></div>
    <div class="prop-row"><div class="prop-lbl"><span>BG Opacity</span><span>${h.bgAlpha}%</span></div>
      <input type="range" min="0" max="100" value="${h.bgAlpha}" oninput="getCard().header.bgAlpha=+this.value;this.previousElementSibling.querySelector('span:last-child').textContent=this.value+'%';renderCanvas();" onchange="pushHist()"></div>
    <div class="prop-row"><div class="prop-lbl"><span>Width</span><span>${h.width}%</span></div>
      <input type="range" min="20" max="100" value="${h.width}" oninput="getCard().header.width=+this.value;this.previousElementSibling.querySelector('span:last-child').textContent=this.value+'%';renderCanvas();updateSelOverlay();" onchange="pushHist()"></div>
    <div class="prop-sep"></div>
    <div class="prop-row"><div class="prop-lbl"><span>Corner Radius</span><span>${h.borderR||8}px</span></div>
      <input type="range" min="0" max="50" value="${h.borderR||8}" oninput="getCard().header.borderR=+this.value;this.previousElementSibling.querySelector('span:last-child').textContent=this.value+'px';renderCanvas();" onchange="pushHist()"></div>
    <div class="prop-row"><label>Border Color</label>
      <input type="color" value="${h.borderC||'#000000'}" oninput="getCard().header.borderC=this.value;renderCanvas();" onchange="pushHist()"></div>
    <div class="prop-row"><div class="prop-lbl"><span>Border Width</span><span>${h.borderW||0}px</span></div>
      <input type="range" min="0" max="10" value="${h.borderW||0}" oninput="getCard().header.borderW=+this.value;this.previousElementSibling.querySelector('span:last-child').textContent=this.value+'px';renderCanvas();" onchange="pushHist()"></div>
    <div class="prop-row"><div class="prop-lbl"><span>Shadow Blur</span><span>${h.shadowBlur||0}px</span></div>
      <input type="range" min="0" max="30" value="${h.shadowBlur||0}" oninput="getCard().header.shadowBlur=+this.value;this.previousElementSibling.querySelector('span:last-child').textContent=this.value+'px';renderCanvas();" onchange="pushHist()"></div>
    <div class="prop-sep"></div>
    <div class="prop-row"><div class="fmt-btns">
      <button class="fmt-btn danger" onclick="deselectEl();renderCanvas();">Deselect</button>
    </div></div>`;
  }

  else if(sel.type==='text'){
    const t=getCard().texts[sel.idx];
    if(!t){deselectEl();return;}
    content.innerHTML=`
    <h3>ğŸ“ Text Box Properties</h3>
    <div class="prop-row"><label>Rich Formatting</label>
      <div class="fmt-btns" id="rich-toolbar">
        <button class="fmt-btn" onclick="richCmd('bold')" title="Bold"><b>B</b></button>
        <button class="fmt-btn" onclick="richCmd('italic')" title="Italic"><i>I</i></button>
        <button class="fmt-btn" onclick="richCmd('underline')" title="Underline"><u>U</u></button>
        <button class="fmt-btn" onclick="richCmd('strikeThrough')" title="Strike"><s>S</s></button>
        <button class="fmt-btn" onclick="richCmd('superscript')">xÂ²</button>
        <button class="fmt-btn" onclick="richCmd('subscript')">xâ‚‚</button>
        <input type="color" value="#000000" class="fmt-btn" style="width:30px;padding:1px;" title="Text colour" onchange="richCmd('foreColor',this.value)">
        <input type="color" value="#ffff00" class="fmt-btn" style="width:30px;padding:1px;" title="Highlight" onchange="richCmd('hiliteColor',this.value)">
        <button class="fmt-btn danger" onclick="richCmd('removeFormat')" title="Clear">âœ•fmt</button>
      </div>
    </div>
    <div class="prop-row"><div class="prop-lbl"><span>Font Family</span></div>
      <select onchange="getCard().texts[${sel.idx}].font=this.value;pushHist();renderCanvas();">${fonts.map(f=>`<option value="${f}" ${f===t.font?'selected':''}>${f}</option>`).join('')}</select></div>
    <div class="prop-row"><div class="prop-lbl"><span>Font Size</span><span>${t.size}px</span></div>
      <input type="range" min="8" max="80" value="${t.size}" oninput="getCard().texts[${sel.idx}].size=+this.value;this.previousElementSibling.querySelector('span:last-child').textContent=this.value+'px';renderCanvas();updateSelOverlay();" onchange="pushHist()"></div>
    <div class="prop-row"><label>Base Text Color</label>
      <input type="color" value="${t.color}" oninput="getCard().texts[${sel.idx}].color=this.value;renderCanvas();" onchange="pushHist()"></div>
    <div class="prop-row"><label>Text Align</label>
      <div class="align-btns">
        ${['left','center','right','justify'].map(a=>`<div class="align-btn${t.align===a?' active':''}" onclick="getCard().texts[${sel.idx}].align='${a}';pushHist();renderCanvas();renderPropsPanel();">${a==='left'?'â¬…':a==='center'?'â¬›':a==='right'?'â¡':'â˜°'}</div>`).join('')}
      </div></div>
    <div class="prop-row"><label>Weight</label>
      <div class="fmt-btns">
        <button class="fmt-btn${t.weight==='normal'?' active':''}" onclick="getCard().texts[${sel.idx}].weight='normal';pushHist();renderCanvas();renderPropsPanel();">Normal</button>
        <button class="fmt-btn${t.weight==='bold'?' active':''}" onclick="getCard().texts[${sel.idx}].weight='bold';pushHist();renderCanvas();renderPropsPanel();"><b>Bold</b></button>
      </div></div>
    <div class="prop-row"><div class="prop-lbl"><span>Line Spacing</span><span>${t.lineSpace}</span></div>
      <input type="range" min="1" max="3" step="0.1" value="${t.lineSpace}" oninput="getCard().texts[${sel.idx}].lineSpace=+this.value;this.previousElementSibling.querySelector('span:last-child').textContent=(+this.value).toFixed(1);renderCanvas();" onchange="pushHist()"></div>
    <div class="prop-row"><div class="prop-lbl"><span>Box Width</span><span>${t.width}%</span></div>
      <input type="range" min="10" max="100" value="${t.width}" oninput="getCard().texts[${sel.idx}].width=+this.value;this.previousElementSibling.querySelector('span:last-child').textContent=this.value+'%';renderCanvas();updateSelOverlay();" onchange="pushHist()"></div>
    <div class="prop-sep"></div>
    <div class="prop-row"><div class="prop-lbl"><span>Position X</span><span>${t.x}%</span></div>
      <input type="range" min="0" max="100" value="${t.x}" oninput="getCard().texts[${sel.idx}].x=+this.value;this.previousElementSibling.querySelector('span:last-child').textContent=this.value+'%';renderCanvas();updateSelOverlay();" onchange="pushHist()"></div>
    <div class="prop-row"><div class="prop-lbl"><span>Position Y</span><span>${t.y}%</span></div>
      <input type="range" min="0" max="100" value="${t.y}" oninput="getCard().texts[${sel.idx}].y=+this.value;this.previousElementSibling.querySelector('span:last-child').textContent=this.value+'%';renderCanvas();updateSelOverlay();" onchange="pushHist()"></div>
    <div class="prop-sep"></div>
    <div class="fmt-btns">
      <button class="fmt-btn danger" onclick="deleteSelected()">ğŸ—‘ Delete Box</button>
      <button class="fmt-btn" style="margin-left:auto;" onclick="deselectEl()">Deselect</button>
    </div>`;
  }

  else if(sel.type==='img'){
    const img=getCard().imgs[sel.idx];
    if(!img){deselectEl();return;}
    content.innerHTML=`
    <h3>ğŸ–¼ Image Properties</h3>
    <div class="prop-row"><label>Image URL</label>
      <input type="text" value="${img.url.startsWith('data:')?'[Embedded image]':img.url}" placeholder="Paste URL or drop image on canvas..." oninput="if(!this.value.startsWith('['))getCard().imgs[${sel.idx}].url=this.value;pushHist();renderCanvas();" style="font-size:11px;"></div>
    <div style="font-size:10px;color:#556677;margin-top:-6px;margin-bottom:8px;">ğŸ’¡ Drop an image file directly onto the canvas to upload automatically</div>
    <div class="prop-row"><div class="prop-lbl"><span>Width</span><span>${img.width}%</span></div>
      <input type="range" min="5" max="100" value="${img.width}" oninput="getCard().imgs[${sel.idx}].width=+this.value;this.previousElementSibling.querySelector('span:last-child').textContent=this.value+'%';renderCanvas();updateSelOverlay();" onchange="pushHist()"></div>
    <div class="prop-row"><div class="prop-lbl"><span>Position X</span><span>${img.x}%</span></div>
      <input type="range" min="0" max="100" value="${img.x}" oninput="getCard().imgs[${sel.idx}].x=+this.value;this.previousElementSibling.querySelector('span:last-child').textContent=this.value+'%';renderCanvas();updateSelOverlay();" onchange="pushHist()"></div>
    <div class="prop-row"><div class="prop-lbl"><span>Position Y</span><span>${img.y}%</span></div>
      <input type="range" min="0" max="100" value="${img.y}" oninput="getCard().imgs[${sel.idx}].y=+this.value;this.previousElementSibling.querySelector('span:last-child').textContent=this.value+'%';renderCanvas();updateSelOverlay();" onchange="pushHist()"></div>
    <div class="prop-sep"></div>
    <div class="prop-row"><label>Crop Tool</label>
      <div class="fmt-btns">
        <button class="fmt-btn" style="background:#f39c12;border-color:#f39c12;" onclick="startCrop()">âœ‚ Open Crop Tool</button>
      </div>
      <div style="font-size:10px;color:#556677;margin-top:4px;">Drag the yellow handles on the canvas to crop, then click Apply.</div>
    </div>
    <div class="prop-row"><div class="prop-lbl"><span>Crop (T/R/B/L)</span></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px;color:#95a5a6;">
        <div>Top: ${(img.crop?.t||0).toFixed(0)}%</div><div>Right: ${(img.crop?.r||0).toFixed(0)}%</div>
        <div>Bottom: ${(img.crop?.b||0).toFixed(0)}%</div><div>Left: ${(img.crop?.l||0).toFixed(0)}%</div>
      </div>
      ${(img.crop?.t||img.crop?.r||img.crop?.b||img.crop?.l)?`<button class="fmt-btn danger" style="margin-top:4px;width:100%;" onclick="getCard().imgs[${sel.idx}].crop={t:0,r:0,b:0,l:0};pushHist();renderCanvas();renderPropsPanel();">âœ• Reset Crop</button>`:''}
    </div>
    <div class="prop-sep"></div>
    <div class="fmt-btns">
      <button class="fmt-btn danger" onclick="deleteSelected()">ğŸ—‘ Delete Image</button>
      <button class="fmt-btn" onclick="deselectEl()">Deselect</button>
    </div>`;
  }
}

// Rich text commands â€” apply to the currently editing element
function richCmd(cmd,val){
  let inner=null;
  if(editingEl){inner=editingEl.querySelector('.c-el-inner');}
  else if(sel.type==="text"){
    const el=getElDOM("text",sel.idx);
    if(el){enterEditMode(el);inner=el.querySelector(".c-el-inner");}
  }
  if(!inner)return;
  inner.focus();
  document.execCommand(cmd,false,val||null);
  // Sync back with sanitization to strip browser-injected font-family noise
  if(sel.type==="text"){
    const baseFont = getCard().texts[sel.idx]?.font;
    const cleaned = sanitizeRichHTML(inner.innerHTML, baseFont);
    if(cleaned !== inner.innerHTML) inner.innerHTML = cleaned;
    getCard().texts[sel.idx].text = cleaned;
    pushHist();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARDS LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCardsList(){
  const list=document.getElementById('cards-list');
  list.innerHTML=cardData.map((c,i)=>`
    <div class="card-pill${i===activeCardIdx?' active':''}" onclick="deselectEl();activeCardIdx=${i};renderAll();">
      <span class="card-pill-num">${i+1}</span>
      <span class="card-pill-title">${c.header.text||'(untitled)'}</span>
      <span class="card-pill-btns">
        <button class="cpb cpb-dup" onclick="duplicateCard(${i},event)">â§‰</button>
        <button class="cpb cpb-del" onclick="deleteCard(${i},event)">âœ•</button>
      </span>
    </div>`).join('');
  document.getElementById('card-counter').textContent=`Card ${activeCardIdx+1} / ${cardData.length}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNC GLOBAL SETTINGS UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncGlobalUI(){
  const s=(id,v)=>{const el=document.getElementById(id);if(el)el.value=v;};
  s('g-bg',globalConfig.bg.color);
  s('g-bgimg',globalConfig.bg.imgUrl||'');
  s('g-trans',globalConfig.transition?.type||'fade');
  s('g-prog',String(globalConfig.progress?.show!==false));
  s('g-font-url',globalConfig.customFont?.url||'');
  s('g-font-name',globalConfig.customFont?.name||'');
  s('g-logo-url',globalConfig.logo?.url||'');
  s('g-logo-w',globalConfig.logo?.width||25);
  document.getElementById('g-logo-w-v').textContent=(globalConfig.logo?.width||25)+'%';
  s('drive-client-id',globalConfig.drive?.clientId||'');
  s('drive-folder-id',globalConfig.drive?.folderId||'');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  renderCardsList();
  renderCanvas();
  renderPropsPanel();
  syncGlobalUI();
  resizeCanvas();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD FILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadHTML(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const doc=new DOMParser().parseFromString(ev.target.result,'text/html');
    const meta=doc.getElementById('studio-save-data');
    if(meta){
      try{
        const data=JSON.parse(decodeURIComponent(atob(meta.getAttribute('content'))));
        cardData=data.cardData.map(c=>{
          if(c.img&&!c.imgs){c.imgs=[c.img];delete c.img;}
          c.imgs=c.imgs.map(i=>({crop:{t:0,r:0,b:0,l:0},...i}));
          return c;
        });
        globalConfig={bg:{color:'#fff',imgUrl:''},progress:{show:true},transition:{type:'fade'},customFont:{url:'',name:''},logo:{url:'',width:25,x:50,y:92},drive:{clientId:'',folderId:''},...data.globalConfig};
        if(globalConfig.customFont?.url)applyFontLink(globalConfig.customFont.url);
        activeCardIdx=0;hist=[];histIdx=-1;deselectEl();renderAll();
        alert('Loaded successfully!');
      }catch(err){alert('Error parsing file.');}
    }else alert('No save data found.');
  };
  reader.readAsText(file);e.target.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GENERATE & DOWNLOAD HTML
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function downloadHTML(){
  const saved={cardData,globalConfig};
  const enc=btoa(encodeURIComponent(JSON.stringify(saved)));

  // â”€â”€ Sanitize all rich text before export to strip browser-injected font noise â”€â”€
  const proc=cardData.map(c=>{
    const nc=JSON.parse(JSON.stringify(c));
    nc.imgs.forEach(i=>{i.url=convDrive(i.url);});
    // Clean each text layer's HTML
    nc.texts=nc.texts.map(t=>({...t, text: sanitizeRichHTML(t.text, t.font)}));
    return nc;
  });

  const lUrl=convDrive(globalConfig.logo.url);
  const logoBlk=lUrl?`<div class="element" style="left:${globalConfig.logo.x}%;top:${globalConfig.logo.y}%;width:${globalConfig.logo.width}%;z-index:10;"><img style="width:100%;height:auto;display:block;" src="${lUrl}"></div>`:'';
  const bgUrl=convDrive(globalConfig.bg.imgUrl);
  const bgStyle=bgUrl?`background-image:url('${bgUrl}');background-size:cover;background-position:center;`:`background-color:${globalConfig.bg.color};`;
  const progBlk=globalConfig.progress.show?'<div id="prog"></div>':'';
  const trans=globalConfig.transition?.type||'fade';
  // â”€â”€ Build a comprehensive font link covering every font actually used â”€â”€
  const fontLinks=buildFontLink();

  const code=`<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Revision Card</title><meta id="studio-save-data" content="${enc}">
${fontLinks}
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;outline:none;}
body{width:100vw;height:100vh;height:100dvh;overflow:hidden;background:#1a1a1a;user-select:none;}
#canvas{position:absolute;left:50%;top:50%;width:375px;height:667px;${bgStyle}transform-origin:center;overflow:hidden;box-shadow:0 0 30px rgba(0,0,0,.6);transform:translate(-50%,-50%);}
#lt,#rt{position:absolute;top:0;height:100%;width:50%;z-index:100;cursor:pointer;}
#lt{left:0;}#rt{right:0;}
.el{position:absolute;transform:translate(-50%,-50%);}
img{display:block;width:100%;height:auto;}
#prog{position:absolute;top:0;left:0;height:6px;background:#3498db;transition:width .3s;z-index:200;}
#cc{position:absolute;inset:0;}
@keyframes aF{from{opacity:0}to{opacity:1}}
@keyframes aSR{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes aSL{from{transform:translateX(-100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes aZ{from{transform:scale(.85);opacity:0}to{transform:scale(1);opacity:1}}
.tf{animation:aF .35s ease forwards;}
.tsr{animation:aSR .3s ease forwards;}
.tsl{animation:aSL .3s ease forwards;}
.tz{animation:aZ .3s ease forwards;}
</style></head><body>
<div id="canvas">
${progBlk}<div id="lt" onclick="p()"></div><div id="rt" onclick="n()"></div>
${logoBlk}<div id="cc"></div></div>
<script>
const D=${JSON.stringify(proc)},T='${trans}';
let i=0,d='r';
const cc=document.getElementById('cc'),pb=document.getElementById('prog');
function resize(){const s=Math.min(innerWidth/375,innerHeight/667);document.getElementById('canvas').style.transform='translate(-50%,-50%) scale('+s+')';}
window.addEventListener('resize',resize);resize();
function h2r(h,a){const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return'rgba('+r+','+g+','+b+','+(a/100)+')';}
function render(){
  const c=D[i];if(pb)pb.style.width=((i+1)/D.length*100)+'%';
  let html='';
  if(c.header&&c.header.text){
    const bg=h2r(c.header.bgColor,c.header.bgAlpha);
    const sw=(c.header.shadowBlur||0)>0?'box-shadow:0 4px '+c.header.shadowBlur+'px '+h2r(c.header.shadowColor||'#000',c.header.shadowAlpha||50)+';':'';
    const bd=(c.header.borderW||0)>0?'border:'+c.header.borderW+'px solid '+(c.header.borderC||'#000')+';':'';
    html+='<div class="el" style="left:'+c.header.x+'%;top:'+c.header.y+'%;width:'+c.header.width+'%;background:'+bg+';color:'+c.header.color+';font-family:\\''+c.header.font+'\\';font-size:'+c.header.size+'px;font-weight:bold;text-align:center;padding:10px 14px;border-radius:'+(c.header.borderR||8)+'px;'+bd+sw+'z-index:15;word-break:break-word;">'+c.header.text+'</div>';
  }
  if(c.texts)c.texts.forEach(t=>{html+='<div class="el" style="width:'+(t.width||85)+'%;left:'+t.x+'%;top:'+t.y+'%;font-family:\\''+t.font+'\\';font-size:'+t.size+'px;font-weight:'+t.weight+';color:'+t.color+';text-align:'+t.align+';line-height:'+t.lineSpace+';word-break:break-word;">'+t.text+'</div>';});
  if(c.imgs)c.imgs.forEach(img=>{if(!img.url)return;const cr=img.crop||{t:0,r:0,b:0,l:0};const cp='inset('+cr.t+'% '+cr.r+'% '+cr.b+'% '+cr.l+'%)';html+='<div class="el" style="left:'+img.x+'%;top:'+img.y+'%;width:'+img.width+'%;"><img src="'+img.url+'" style="clip-path:'+cp+';border-radius:6px;"></div>';});
  cc.className='';cc.innerHTML=html;void cc.offsetWidth;
  const cls=T==='none'?'':T==='fade'?'tf':T==='slide'?(d==='r'?'tsr':'tsl'):'tz';
  if(cls)cc.className=cls;
}
function n(){if(i<D.length-1){d='r';i++;render();}}
function p(){if(i>0){d='l';i--;render();}}
render();
<\/script></body></html>`;

  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([code],{type:'text/html'}));
  a.download='Revision_Card_Final.html';a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderAll();
setTimeout(()=>{
  hist=[JSON.parse(JSON.stringify({cardData,globalConfig}))];
  histIdx=0;updUndoBtns();
},500);
</script>
</body>
</html>
